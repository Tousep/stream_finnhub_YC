# Потоковая обработка данных Finhub в YandexCloud

Данный проект представляет собой поток реального времени на основе данных транзакций Finnhub.io API/websocket. Он демонстрирует ключевые аспекты проектированияи архитектуры стримминг конвейера для обеспечения низкой задержки, масштабируемости и доступности.

# Архитектура
![Arch](https://github.com/Tousep/stram-finnhub2click_ydb/assets/88712939/36468252-9a09-46ac-8e34-6f16cadd0575)
Диаграмма выше дает представление об архитектуре проекта.

Все приложения распологаются в сервисах YandexCloud (YC). Инфраструктурой управляет Terraform.

## Уровень приема данных

Контейнерное приложение Python - FinnhubProducer подключается к веб-сокету Finnhub.io. Он разбивает сообщения на атомарные записи и помещает сообщения в топик finnhub_market брокера Kafka. Котнейнер размещен в Container Registry и запускается с помощью триггера в Servless Container.

## Уровень брокера сообщений 

Сообщения от FinnhubProducer передаются в топик finnhub_market брокера Kafka , который расположен в кластере Managed Service for Kafka.

## Уровень потоковой обработки 

Трансфер данных с помощью эндпоинта источника подключается к Kafka, а с помощью эндпоинта назначения подключается к кластеру ClicHouse и в режиме реального времени переносит данные.

## Уровень базы данных

База данных ClickHouse хранит данные полученные из трансфера. Clichouse развернут в клвстере Managed Service for ClickHouse.

## Уровень визуализации

Дашборды построенны в сервисе DataLens. Извлекает данные из ClickHouse. Панель мониторинга обновляется каждые 30с.
![finnhub_dash](https://github.com/Tousep/stram-finnhub2click_ydb/assets/88712939/2b8cb3cc-6915-4d49-86cb-3ef26b54d615)

# Настройка и развертывание

- собрать контейнер и поместить его в Container registry
  docker build . -t cr.yandex/crpklr23obfr3io36pqr/finnhub_producer:a46
  docker push cr.yandex/crpklr23obfr3io36pqr/finnhub_producer:a46
- создать триггер на регулярный запуск контейнера.
- Создать эндпоинт источника kafka для дата трансфера.
- Развернуть архитектуру с помоью Terraform развернуть архитектуру. предварительно изменив параметры:
   * yandex_datatransfer_transfer
     * source_id - указать id эндпоинта из шага 3.
   * yandex_serverless_container
     * service_account_id - идентификатор сервисного аккауна YC.
     * KAFKA_SERVER - адрес кластера Kafka.
     * FINNHUB_API_TOKEN - Ключ API для подключения к webSocket finnhub(нужно зарегистрироваться).
     * url - url загруженного в шаге 1 контейнера.
   * provider yandex
     * service_account_key_file - Файл с ключами для подключения к облаку
     *  folder_id - адрес каталога ресурс менеджера YC
   * yandex_container_registry
     *  folder_id - адрес каталога ресурс менеджера YC
  
# Потенциальные улучшения
* Создание единного конфигурационного файла для параметров развертывания.
* Использование Yandex Secrets для ключей.
* Добавленеи развертываня триггера запуск контейнера уровня приема данных с использованием terraform.
* Добавленеи развертываня эндпоинта источника Kafka с использованием terraform.
* Рефакторинг кода и дальнейшее развитие
